name: æ£€æŸ¥ä¸Šæ¸¸commitsæ›´æ–°å¹¶è§¦å‘ç¼–è¯‘ä»“åº“

on:
  workflow_dispatch:
  schedule:
    - cron: '40 19 * * *'  # ä¸­å›½æ—¶é—´æ¯å¤©å‡Œæ™¨3:20ï¼ˆUTC 18:40ï¼‰

jobs:
  check-repos:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo_group:
          - id: immortalwrt-group
            repos:
              - id: immortalwrt
                url: https://github.com/immortalwrt/immortalwrt
                branch: master
                event: immortalwrt-update
              - id: immortalwrt-packages
                url: https://github.com/immortalwrt/packages
                branch: master
                event: immortalwrt-packages-update
              - id: luci-packages
                url: https://github.com/immortalwrt/luci
                branch: master
                event: immortalwrt-luci-update
          - id: lede-group
            repos:
              - id: lede
                url: https://github.com/coolsnowwolf/lede
                branch: master
                event: lede-update
              - id: lede-luci
                url: https://github.com/coolsnowwolf/luci
                branch: master
                event: lede-luci-update
              - id: lede-packages
                url: https://github.com/coolsnowwolf/packages
                branch: master
                event: lede-packages-update

    steps:
    - name: è®¾ç½®ç¼“å­˜ç›®å½•è·¯å¾„
      id: vars
      run: |
        echo "cache_path=.cache/${{ matrix.repo_group.id }}" >> $GITHUB_OUTPUT
        # ä½¿ç”¨å›ºå®šçš„ç¼“å­˜é”®ï¼Œä¸åŒ…å« github.run_id
        echo "cache_key=commit-${{ matrix.repo_group.id }}-latest" >> $GITHUB_OUTPUT
        # æ·»åŠ æ¢å¤é”®ä»¥æ”¯æŒå‘åå…¼å®¹
        echo "restore_keys=commit-${{ matrix.repo_group.id }}-" >> $GITHUB_OUTPUT

    # ä¿®æ”¹æ¢å¤ç¼“å­˜æ­¥éª¤
    - name: æ¢å¤ä¸Šæ¬¡ç¼“å­˜çš„æäº¤å“ˆå¸Œ
      id: restore-cache
      uses: actions/cache@v4
      with:
        path: ${{ steps.vars.outputs.cache_path }}
        key: ${{ steps.vars.outputs.cache_key }}
        restore-keys: ${{ steps.vars.outputs.restore_keys }}

    - name: æ£€æŸ¥ ${{ matrix.repo_group.id }} æ›´æ–°
      id: check-update
      run: |
        GROUP_HASH=""
        for repo in $(echo '${{ toJson(matrix.repo_group.repos) }}' | jq -c '.[]'); do
          REPO_ID=$(echo $repo | jq -r '.id')
          REPO_URL=$(echo $repo | jq -r '.url')
          REPO_BRANCH=$(echo $repo | jq -r '.branch')
          # ç›´æ¥è·å–æœ€æ–° commit å“ˆå¸Œï¼Œé¿å…å®Œæ•´å…‹éš†
          LATEST_HASH=$(git ls-remote $REPO_URL $REPO_BRANCH | cut -f1)
          echo "ä»“åº“ $REPO_ID æœ€æ–°æäº¤: $LATEST_HASH"
          GROUP_HASH="$GROUP_HASH$LATEST_HASH"
        done
        GROUP_HASH=$(echo -n "$GROUP_HASH" | sha256sum | awk '{print $1}')
        echo "ç»„ ${{ matrix.repo_group.id }} ç»„åˆå“ˆå¸Œ: $GROUP_HASH"
        echo "GROUP_HASH=$GROUP_HASH" >> $GITHUB_ENV  # æä¾›ç»™è§¦å‘å™¨ä½¿ç”¨

        # å®šä½ç¼“å­˜æ–‡ä»¶
        CACHE_FILE="${{ steps.vars.outputs.cache_path }}/last_commit"
        mkdir -p "$(dirname "$CACHE_FILE")"

        # åœ¨æ£€æŸ¥æ›´æ–°æ­¥éª¤ä¸­æ·»åŠ 
        if [[ -f "$CACHE_FILE" ]]; then
          OLD_HASH=$(cat "$CACHE_FILE")
          echo "ç¼“å­˜ä¸­çš„æ—§å“ˆå¸Œ: $OLD_HASH"
          if [[ "$OLD_HASH" == "$GROUP_HASH" ]]; then
            echo "has_update=false" >> "$GITHUB_OUTPUT"
            echo "æ— æ–°æäº¤"
            exit 0
          fi
        fi

        # æœ‰æ›´æ–°
        echo "$GROUP_HASH" > "$CACHE_FILE"
        echo "has_update=true" >> "$GITHUB_OUTPUT"
        echo "æ£€æµ‹åˆ°æ–°æäº¤ï¼"

    - name: è§¦å‘æ„å»º
      if: steps.check-update.outputs.has_update == 'true'
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.ACTIONS_TRIGGER_PAT }}
        event-type: ${{ matrix.repo_group.id }}-update
        client-payload: >-
          {
            "group_id": "${{ matrix.repo_group.id }}",
            "commit_hash": "${{ env.GROUP_HASH }}"
          }

    - name: ğŸ’¾ ä¿å­˜æœ€æ–° commit å“ˆå¸Œåˆ°ç¼“å­˜
      if: steps.check-update.outputs.has_update == 'true'
      uses: actions/cache/save@v4
      with:
        path: ${{ steps.vars.outputs.cache_path }}
        key: ${{ steps.vars.outputs.cache_key }}


    - name: åˆ é™¤æ—§å·¥ä½œæµè¿è¡Œè®°å½•
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.ACTIONS_TRIGGER_PAT }}
        repository: ${{ github.repository }}
        retain_days: 3
        keep_minimum_runs: 3
