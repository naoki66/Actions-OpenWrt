name: "æ„å»ºimmortalwrt24.10-X64å›ºä»¶"

on:
  repository_dispatch:
    types: 
      - immortalwrt-group-update
  workflow_dispatch:
  schedule:
    - cron: '40 19 */7 * *'    # æ¯ 7 å¤©åŒ—äº¬æ—¶é—´ 03:40

env:
  # â”€â”€â”€â”€â”€ æºç ä¸è„šæœ¬ â”€â”€â”€â”€â”€
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: DIY_immortalwrt_feeds.conf.default
  CONFIG_FILE: ImmortalWrt_x64.config
  DIY_P1_SH: ImmortalWrt-diy-part1.sh
  DIY_P2_SH: ImmortalWrt-diy-part2.sh

  # â”€â”€â”€â”€â”€ ä¸Šä¼ /å‘å¸ƒé€‰é¡¹ â”€â”€â”€â”€â”€
  UPLOAD_FIRMWARE: 'true'
  UPLOAD_RELEASE: 'true'

  # â”€â”€â”€â”€â”€ æ„å»ºå‚æ•° â”€â”€â”€â”€â”€
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_COMPRESS: '1'
  CCACHE_MAXSIZE: "2G"

jobs:
  build-firmware:
    name: æ„å»ºå›ºä»¶
    runs-on: ubuntu-22.04
    concurrency:
      group: immortalwrt-${{ github.ref }}  # æŒ‰åˆ†æ”¯éš”ç¦»å¹¶å‘
      cancel-in-progress: true             # å–æ¶ˆæ—§ä»»åŠ¡ï¼Œæ‰§è¡Œæœ€æ–°ä»»åŠ¡
    permissions:
      contents: write   # å…è®¸æ¨é€æ„å»ºäº§ç‰©åˆ°ä»“åº“
      actions: write    # å…è®¸è§¦å‘å…¶ä»–å·¥ä½œæµ

    steps:
# 1ï¸âƒ£ æ£€å‡ºä»“åº“å¹¶è®°å½•å¼€å§‹æ—¶é—´
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1

    - name: è®°å½•å¼€å§‹æ—¶é—´
      run: |
        echo "TIME0=$(date '+%Y-%m-%d %H:%M:%S')" >> "$GITHUB_ENV"
        echo "RELEASE_TAG=$(date '+%Y.%m.%d-%H%M')" >> "$GITHUB_ENV"
        
# 2ï¸âƒ£ å‡†å¤‡æ„å»ºç¯å¢ƒ
    - name: å‡†å¤‡æ„å»ºç¯å¢ƒ
      env: { DEBIAN_FRONTEND: noninteractive }
      run: |
        sudo rm -rf /usr/share/{dotnet,man,doc,groff,info,lintian,linda,locale} \
                    /usr/local/lib/android /opt/ghc /usr/lib/jvm /usr/share/swift \
                    /usr/local/go /opt/hostedtoolcache/* /usr/share/az_*
        sudo docker system prune -af --volumes || true
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y --no-install-recommends \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 \
            ccache clang cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
            git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
            libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool llvm lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full \
            patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons \
            squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir 
        sudo chown $USER:$GROUPS /workdir


# 3ï¸âƒ£ å…‹éš†æºç 
    - name: å…‹éš† ImmortalWrt æºç 
      working-directory: /workdir
      run: |
          df -hT $PWD
          git clone -b $REPO_BRANCH --single-branch --filter=blob:none $REPO_URL immortalwrt
          ln -sf $PWD/immortalwrt $GITHUB_WORKSPACE/immortalwrt

# 4ï¸âƒ£  å…·é“¾ç¼“å­˜
    - name: ç¼“å­˜ ccache
      uses: actions/cache@v4
      with:
        path: /workdir/immortalwrt/.ccache
        key: ccache-immortalwrt-${{ github.ref_name }}
        restore-keys: ccache-immortalwrt-${{ github.ref_name }}

    - name:  ç¼“å­˜ dl
      uses: actions/cache@v4
      with:
          path: /workdir/immortalwrt/dl
          key: dl-immortalwrt-${{ hashFiles('feeds.conf.default') }}
          restore-keys: dl-immortalwrt-${{ hashFiles('feeds.conf.default') }}

    - name: ç¼“å­˜ toolchain
      uses: actions/cache@v4
      with:
        path: /workdir/immortalwrt/staging_dir
        key: toolchain-immortalwrt-${{ hashFiles('toolchain/**', 'include/**') }}
        restore-keys: toolchain-immortalwrt-${{ hashFiles('toolchain/**', 'include/**') }}

    - name: ç¼“å­˜ feeds
      uses: actions/cache@v4
      with:
          path: /workdir/immortalwrt/feeds
          key: feeds-immortalwrt-${{ hashFiles('feeds.conf.default') }}
          restore-keys: feeds-immortalwrt-${{ hashFiles('feeds.conf.default') }}

    - name: ç¼“å­˜ host tools
      uses: actions/cache@v4
      with:
            path: /workdir/immortalwrt/build_dir/host*
            key: hosttools-immortalwrt-${{ github.ref_name }}
            restore-keys: hosttools-immortalwrt-${{ github.ref_name }}

    # 5ï¸âƒ£ è‡ªå®šä¹‰ feedsï¼ŒDIY_P1_SH
    - name: åº”ç”¨è‡ªå®šä¹‰feedså’ŒDIY_P1_SH
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF immortalwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd immortalwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH


    # 6ï¸âƒ£ æ›´æ–°å’Œå®‰è£… feeds
    - name: æ›´æ–°å’Œå®‰è£… feeds
      run: |
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a -f


    # 7ï¸âƒ£ è‡ªå®šä¹‰é…ç½®configï¼ŒDIY_P2_SH
    - name: è‡ªå®šä¹‰é…ç½®configï¼ŒDIY_P2_SH
      run: |
        [ -e "ImmortalWrt_Files" ] && mv ImmortalWrt_Files immortalwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE immortalwrt/.config
        chmod +x $DIY_P2_SH
        cd immortalwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH        


    # 8ï¸âƒ£ é€šè¿‡APIç”Ÿæˆä¸Šæ¸¸ä¸€å‘¨æ›´æ–°æ—¥å¿—
    - name: é€šè¿‡APIç”Ÿæˆä¸Šæ¸¸ä¸€å‘¨æ›´æ–°æ—¥å¿—
      run: |
        echo "CHANGELOG_CONTENT<<EOF" > changelog_env.txt
        echo "-  ğŸ”§ [immortalwrt ä¸»ä»“åº“](https://github.com/immortalwrt/immortalwrt)" >> changelog_env.txt
        curl -s "https://api.github.com/repos/immortalwrt/immortalwrt/commits?since=$(date -d '-7 days' --iso-8601=s)" \
          | jq -r '.[]? | select(.commit != null) | "- [\(.commit.committer.date)] \(.commit.message | split("\n")[0])"' >> changelog_env.txt 2>/dev/null || true
        echo "-  ğŸ“¦ [immortalwrt packages](https://github.com/immortalwrt/packages)" >> changelog_env.txt
        curl -s "https://api.github.com/repos/immortalwrt/packages/commits?since=$(date -d '-7 days' --iso-8601=s)" \
          | jq -r '.[]? | select(.commit != null) | "- [\(.commit.committer.date)] \(.commit.message | split("\n")[0])"' >> changelog_env.txt 2>/dev/null || true
        echo "-  ğŸ–¥ï¸ [immortalwrt luci](https://github.com/immortalwrt/luci)" >> changelog_env.txt
        curl -s "https://api.github.com/repos/immortalwrt/luci/commits?since=$(date -d '-7 days' --iso-8601=s)" \
          | jq -r '.[]? | select(.commit != null) | "- [\(.commit.committer.date)] \(.commit.message | split("\n")[0])"' >> changelog_env.txt 2>/dev/null || true
        echo "EOF" >> changelog_env.txt
        cat changelog_env.txt >> $GITHUB_ENV

    # 9ï¸âƒ£ ä¸‹è½½æºä»£ç åŒ…
    - name: ä¸‹è½½æºä»£ç åŒ…
      id: package
      run: |
          cd immortalwrt
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          
    # ğŸ”Ÿ ç¼–è¯‘å›ºä»¶
    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
          cd immortalwrt
          make V=s -j2 || make V=s -j1

    # 1ï¸âƒ£1ï¸âƒ£ æ•´ç†å›ºä»¶
    - name: æ•´ç†è¾“å‡ºè·¯å¾„
      id: organize
      run: |
          cd immortalwrt/bin/targets/*/*
          rm -rf packages
          df -hT  
          echo "FIRMWARE_DIR=$PWD" >> $GITHUB_ENV
          echo "TIME1=$(date '+%Y-%m-%d %H:%M:%S')" >> "$GITHUB_ENV"

       # 1ï¸âƒ£2ï¸âƒ£ è®¡ç®—ç¼–è¯‘è€—æ—¶
    - name: è®¡ç®—ç¼–è¯‘è€—æ—¶
      run: |
        # å°† TIME0 å’Œ TIME1 è½¬æ¢ä¸º Unix æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
        START_TIME=$(date -u -d "${{ env.TIME0 }}" +%s)
        END_TIME=$(date -u -d "${{ env.TIME1 }}" +%s)
        # è®¡ç®—æ—¶é—´å·®ï¼ˆç§’ï¼‰
        ELAPSED_SECONDS=$((END_TIME - START_TIME))
        # æ ¼å¼åŒ–ä¸º HHh MMm SSs
        ELAPSED_FORMATTED=$(printf "%02dh %02dm %02ds" $((ELAPSED_SECONDS/3600)) $((ELAPSED_SECONDS%3600/60)) $((ELAPSED_SECONDS%60)))
        # è¾“å‡ºç»“æœåˆ°ç¯å¢ƒå˜é‡
        echo "ELAPSED=$ELAPSED_FORMATTED" >> $GITHUB_ENV
        echo "::notice::æ€»è€—æ—¶: $ELAPSED"
        #æ£€æŸ¥å›ºä»¶ç›®å½•å†…å®¹
        ls -lh ${{ env.FIRMWARE_DIR }}     


    # 1ï¸âƒ£3ï¸âƒ£ ä¸Šä¼ å›ºä»¶äº§ç‰©
    - name: ä¸Šä¼ å›ºä»¶äº§ç‰©
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
          name: immortalwrt24.10-${{ github.run_number }}
          path: ${{ env.FIRMWARE_DIR }}

   # 1ï¸âƒ£4ï¸âƒ£ åˆ›å»º GitHub å‘å¸ƒç‰ˆæœ¬
    - name: åˆ›å»º GitHub å‘å¸ƒç‰ˆæœ¬
      if: env.UPLOAD_RELEASE == 'true'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.ACTIONS_TRIGGER_PAT }}      
      with:
          tag_name: immortalwrt24.10-${{ env.RELEASE_TAG }}
          name: immortalwrt24.10-X64-${{ env.RELEASE_TAG }}
          body: |
            ğŸ“¦ **ç¼–è¯‘æ—¶é—´æ®µ**  
            â° ä» **${{ env.TIME0 }}** åˆ° **${{ env.TIME1 }}**  
            ğŸ•’ **æ€»è€—æ—¶ï¼š${{ env.ELAPSED }}**
            ğŸ”„ **ä¸Šæ¸¸æ›´æ–°æ—¥å¿—**  
              ${{ env.CHANGELOG_CONTENT || 'æ— æ›´æ–°æ—¥å¿—å†…å®¹' }}
          files: ${{ env.FIRMWARE_DIR }}/*

    # 1ï¸âƒ£5ï¸âƒ£ æ¸…ç†æ—§ Workflow è®°å½•
    - name: æ¸…ç†æ—§ Workflow è®°å½•
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.ACTIONS_TRIGGER_PAT }}
        retain_days: 15
        keep_minimum_runs: 10

   # 1ï¸âƒ£6ï¸âƒ£ æ¸…ç†æ—§ç‰ˆæœ¬
    - name: æ¸…ç†æ—§ Release
      if: env.UPLOAD_RELEASE == 'true' 
      env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TRIGGER_PAT }}
      uses: dev-drprasad/delete-older-releases@v0.3.4
      with:
          keep_latest: 15
          delete_tags: true
